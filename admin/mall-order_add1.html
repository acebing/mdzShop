<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>买得商城</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="./layui/css/layui.css">
  <link rel="stylesheet" href="./js/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="./css/iconfont.css">
  <link rel="stylesheet" type="text/css" href="./css/font-awesome.min.css">
  <link rel="stylesheet" href="./css/perfect-scrollbar.min.css">
  <link rel="stylesheet" href="./css/purebox.css">
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/order-new.css">
  <link rel="stylesheet" href="./css/mdz.css">
  <!-- js部分 -->
  <script src="http://www.jq22.com/jquery/jquery-2.1.1.js"></script>
  <script src="./js/jquery-ui/jquery-ui.min.js"></script>
  <script src="./layui/layui.js"></script>
  <script src="./js/mdz-layui.js"></script>
  <script src="./js/jquery.validation.min.js"></script>
  <script src="./js/perfect-scrollbar.min.js"></script>
  <script src="./js/lib_ecmobanFunc.js"></script>
  <script src="./js/listtable.js"></script>
  <script src="./js/region.js"></script>
  <script src="./js/common.js"></script>
  <script src="./js/admin.js"></script>
</head>
<body>
  <div class="layui-layout layui-layout-admin">
    <div class="layui-header">
      <div class="layui-logo"><img src="./images/admin_logo.png" alt="" style="width: 210px;height: 25px"></div>
      <!-- 头部区域（可配合layui已有的水平导航） -->
      <ul class="layui-nav layui-layout-left">
        <li class="layui-nav-item"><a href="">平台设置</a></li>
        <li class="layui-nav-item layui-this"><a href="">商城管理</a></li>
        <li class="layui-nav-item"><a href="">财务管理</a></li>
        <li class="layui-nav-item"><a href="">微商城</a></li>
        <li class="layui-nav-item"><a href="">小程序</a></li>
      </ul>
      <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item">
          <a href="javascript:;">
            <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
            沈总
          </a>
          <dl class="layui-nav-child">
            <dd><a href="">基本资料</a></dd>
            <dd><a href="">安全设置</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
         <a href="">
          <i class="layui-icon layui-icon-notice" style="font-size: 20px; color: #FFF;"></i><span class="layui-badge">99</span>
        </a>
      </li>
      <li class="layui-nav-item">
      	<a href="">
      		<i class="layui-icon layui-icon-website" style="font-size: 20px; color: #FFF;"></i>
      	</a>
      </li>
      <li class="layui-nav-item">
      	<a href="">
      		<i class="layui-icon layui-icon-theme" style="font-size: 20px; color: #FFF;"></i>
      	</a>
      </li>
      <li class="layui-nav-item">
      	<a href="">
      		<i class="layui-icon layui-icon-fonts-clear" style="font-size: 20px; color: #FFF;"></i>
      	</a>
      </li>
      <li class="layui-nav-item">
      	<a href="">
      		<i class="layui-icon layui-icon-close-fill" style="font-size: 20px; color: #FFF;"></i>
      	</a>
      </li>
    </ul>
  </div>
  
  <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree"  lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a class="" href="javascript:;">平台商品管理</a>
          <dl class="layui-nav-child">
            <dd class="layui-this"><a href="javascript:;">商品列表</a></dd>
            <dd><a href="javascript:;">商品分类</a></dd>
            <dd><a href="javascript:;">品牌管理</a></dd>
            <dd><a href="javascript:;">评论管理</a></dd>
            <dd><a href="javascript:;">商品类型</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">超市商品管理</a>
          <dl class="layui-nav-child">
            <dd ><a href="javascript:;">商品列表</a></dd>
            <dd><a href="javascript:;">商品分类</a></dd>
            <dd><a href="javascript:;">品牌管理</a></dd>
            <dd><a href="javascript:;">评论管理</a></dd>
            <dd><a href="javascript:;">商品类型</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">省鲜生商品管理</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">商品列表</a></dd>
            <dd><a href="javascript:;">商品分类</a></dd>
            <dd><a href="javascript:;">品牌管理</a></dd>
            <dd><a href="javascript:;">评论管理</a></dd>
            <dd><a href="javascript:;">商品类型</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">订单管理</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">订单列表</a></dd>
            <dd><a href="javascript:;">添加订单</a></dd>
            <dd><a href="javascript:;">发货单列表</a></dd>
            <dd><a href="javascript:;">退货单列表</a></dd>
            <dd><a href="javascript:;">退货原因列表</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">文章管理</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">文章分类</a></dd>
            <dd><a href="javascript:;">文章列表</a></dd>
            <dd><a href="javascript:;">自动发布</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">会员管理</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">会员列表</a></dd>
            <dd><a href="javascript:;">资金管理</a></dd>
            <dd><a href="javascript:;">充值/提现</a></dd>
            <dd><a href="javascript:;">收货地址</a></dd>
            <dd><a href="javascript:;">发票</a></dd>
            <dd><a href="javascript:;">投诉管理</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="" href="javascript:;">活动促销</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">限时秒杀</a></dd>
          
          </dl>
        </li>
      </ul>
    </div>
  </div>
  
  <div class="layui-body" style="padding: 20px;">
  	<span class="layui-breadcrumb">
     <a href="">订单管理</a>
     <a><cite>订单列表</cite></a>
   </span>
   <div class="layui-tab-content">
    <div class="explanation mb10" id="explanation">
      <div class="ex_tit"><i class="sc_icon"></i><h4>操作提示</h4><span id="explanationZoom" title="收起提示"></span></div>
      <ul>
        <li>标识“<em>*</em>”的选项为必填项，其余为选填项。</li>
        <li>添加订单流程为：选择商城已有会员-选择商品加入订单-确认订单金额-填写收货信息-添加配送方式-选择支付方式-添加发票-查看费用信息-完成。</li>
      </ul>
    </div>
    <div class="flexilist mt30">
      <div class="common-content">
        <div class="step">
          <form name="theForm" action="order.php?act=step_post&amp;step=edit_goods&amp;order_id=1696&amp;step_act=add" method="post">
            <div class="step_info">
              <div class="add_goods_list">
                <table class="table" cellpadding="0" cellspacing="0">
                  <tbody><tr>
                    <th width="30%" class="tc">商品名称</th>
                    <th width="10%">货号</th>
                    <th width="12%">价格</th>
                    <th width="10%">数量</th>
                    <th width="13%">属性</th>
                    <th width="10%">小计</th>
                    <th width="5%">操作</th>
                    <th class="total tc" width="10%" rowspan="3"><a href="javascript:;" onclick="submit()"><i class="icon icon-refresh"></i></a><span>合计：&nbsp;&nbsp;28</span><input name="goods_count" type="hidden" value=""></th>
                  </tr>
                  <tr>
                    <td class="goods_info">
                      <a href="javascript:;" onclick="getGoodsInfo(2742);">【维摩乡】田坝心村 纯手工传统工艺糯米绿粑粑（3袋全国包邮）</a>

                    </td>
                    <td>MDZ002742<input name="rec_id[]" type="hidden" value="1784"></td>
                    <td>
                      <input name="goods_price[]" type="text" class="text w50" autocomplete="off" value="16.00">
                      <input name="goods_id[]" type="hidden" class="text w50" autocomplete="off" value="2742">
                      <input name="goods_attr[]" type="hidden" class="text w50" autocomplete="off" value="">
                    </td>
                    <td><input type="text" class="text w50" name="goods_number[]" autocomplete="off" value="1"></td>
                    <td></td>
                    <td>16.00</td>
                    <td><a href="javascript:confirm_redirect(confirm_drop, 'order.php?act=process&amp;func=drop_order_goods&amp;rec_id=1784&amp;step_act=add&amp;order_id=1696')">删除</a></td>
                  </tr>
                  <tr>
                    <td class="goods_info">
                      <a href="javascript:;" onclick="getGoodsInfo(2743);">高原红皮花生350g（3件全国包邮）</a>

                    </td>
                    <td>MDZ002743<input name="rec_id[]" type="hidden" value="1785"></td>
                    <td>
                      <input name="goods_price[]" type="text" class="text w50" autocomplete="off" value="12.00">
                      <input name="goods_id[]" type="hidden" class="text w50" autocomplete="off" value="2743">
                      <input name="goods_attr[]" type="hidden" class="text w50" autocomplete="off" value="红皮花生">
                    </td>
                    <td><input type="text" class="text w50" name="goods_number[]" autocomplete="off" value="1"></td>
                    <td>红皮花生</td>
                    <td>12.00</td>
                    <td><a href="javascript:confirm_redirect(confirm_drop, 'order.php?act=process&amp;func=drop_order_goods&amp;rec_id=1785&amp;step_act=add&amp;order_id=1696')">删除</a></td>
                  </tr>
                </tbody></table>
              </div>
            </div>
          </form>
          <form name="goodsForm" action="order.php?act=step_post&amp;step=add_goods&amp;order_id=1696&amp;step_act=add" method="post" onsubmit="return addToOrder()">
            <div class="goods_search_filer">
              <strong>按商品编号或商品名称或商品货号搜索</strong>
              <input type="text" name="keyword" class="text w120" autocomplete="off" placeholder="编号/名称/货号">
              <a href="javascript:;" name="search" onclick="searchGoods();" class="btn btn30 blue_btn mr20"><i class="icon icon-search"></i> 搜索 </a>

              <div class="select" id="search_result">
                <div id="goodslist" class="imitate_select select_w500">
                  <div class="cite">2743  高原红皮花生350g（3件全国包邮）  MDZ002743</div>
                  <ul style="display: none;" class="ps-container">

                    <li><a href="javascript:;" data-value="2743" class="ftx-01">2743  高原红皮花生350g（3件全国包邮）  MDZ002743</a></li><div class="ps-scrollbar-x-rail" style="width: 499px; display: none; left: 0px; bottom: 3px;"><div class="ps-scrollbar-x" style="left: 0px; width: 0px;"></div></div><div class="ps-scrollbar-y-rail" style="top: 0px; height: 28px; display: none; right: 0px;"><div class="ps-scrollbar-y" style="top: 0px; height: 0px;"></div></div></ul>
                    <input name="goodslist" type="hidden" value="2743" id="goodslist_val">
                  </div>
                </div>
              </div>
              <div class="goods_info_add">
                <div class="goods_info_desc">
                  <table class="table">
                    <tbody><tr>
                      <td class="goods_info_left">商品名称</td>
                      <td class="goods_info_right first"><div id="goods_name">高原红皮花生350g（3件全国包邮）</div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">货号</td>
                      <td class="goods_info_right"><div id="goods_sn">MDZ002743</div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">分类</td>
                      <td class="goods_info_right"><div id="goods_cat">维摩乡</div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">品牌</td>
                      <td class="goods_info_right"><div id="goods_brand"></div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">价格</td>
                      <td class="goods_info_right"><div id="add_price" class="checkbox_items"><div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="market_price" value="14.39"><label for="market_price" class="ui-radio-label">市场价 [14.39]</label></div><div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="shop_price" value="12.00" checked=""><label for="shop_price" class="ui-radio-label">本店售价 [12.00]</label></div><div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="custom_price" value="user_input"><label for="custom_price" class="ui-radio-label mr10">自定义价格</label><input type="text" id="custom_price_value" name="input_price" class="text w120" value="" style="display:none;"></div></div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">属性<input type="hidden" name="spec_count" value="1"></td>
                      <td class="goods_info_right"><div id="goods_attr"><div class="checkbox_items"><div class="attr_name">种类：</div><div class="checkbox_item"><input onclick="get_attr_number(2743,0,0,0,0,2681)" type="radio" name="spec_0" value="4085" class="ui-radio" id="attr_4085" checked=""><label class="ui-radio-label" for="attr_4085">红皮花生</label></div><div class="checkbox_item"><input onclick="get_attr_number(2743,0,0,0,0,2681)" type="radio" name="spec_0" value="4086" class="ui-radio" id="attr_4086"><label class="ui-radio-label" for="attr_4086">粉皮花生</label></div><div class="checkbox_item"><input onclick="get_attr_number(2743,0,0,0,0,2681)" type="radio" name="spec_0" value="5168" class="ui-radio" id="attr_5168"><label class="ui-radio-label" for="attr_5168"></label></div></div></div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">库存</td>
                      <td class="goods_info_right"><div id="goods_storage">500</div></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">数量</td>
                      <td class="goods_info_right"><input name="add_number" class="text w80" type="text" autocomplete="off" value="1"></td>
                    </tr>
                    <tr>
                      <td class="goods_info_left">加入订单</td>
                      <td class="goods_info_right last">
                        <input name="add_goods" type="submit" value="加入订单" class="btn btn30 red_btn">
                        <input name="model_attr" value="0" type="hidden">
                        <input name="attr_price" value="0" type="hidden">
                      </td>
                    </tr>
                  </tbody></table>
                </div>                           
              </div>
            </form>
            <form action="order.php?act=step_post&amp;step=goods&amp;order_id=1696&amp;step_act=add" method="post" name="theFormNext" onsubmit="return subOrderAdd()">
              <div class="goods_btn" id="button-info">
                <input type="button" value="取消" class="btn btn35 btn_blue" onclick="location.href='order.php?act=process&amp;func=cancel_order&amp;order_id=1696&amp;step_act=add'">
                <input type="button" class="btn btn35 btn_blue" onclick="history.back()" value="上一步">
                <input name="next" type="submit" class="btn btn35 blue_btn" value="下一步">
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="layui-footer">
      <!-- 底部固定区域 -->
      <div  class="layui-main" style="text-align: center;">买得着商城<i class="heart">❤</i>不忘初心</div>
    </div>
  </div>
</body>
<script src="./js/jquery.purebox.js"></script>
<script type="text/javascript">

var step = 'goods';
var orderId = 1696;
var act = 'add';

//地区三级联动
$.levelLink();

$(function(){
    $(".checkbox_user").find(".ui-radio").click(function(){
        var checkbox = $(this).parents(".checkbox_user");
        checkbox.addClass("checked_user").siblings().removeClass("checked_user");

        if($("#register_user").is(":checked")){
            $(".register_user_warp").find("input[type='text']").attr("readonly",false);
            $(".register_user_warp").find(".div_readonly").hide();
        }else{
            $(".register_user_warp").find("input[type='text']").attr("readonly",true);
            $(".register_user_warp").find(".div_readonly").show();
        }
    });
    $(document).on("click","input[name='add_price']",function(){
        if($(this).attr("id") == "custom_price"){
            $("#custom_price_value").show();
        }else{
            $("#custom_price_value").hide();
        }
    });
  
  //收货地址
  $("#submitBtn").click(function(){
    if($("#consignee").valid()){
      $("#consignee").submit();
    }
  });
  
  $('#consignee').validate({
    errorPlacement:function(error, element){
      var error_div = element.parents('div.step_value').find('div.form_prompt');
      element.parents('div.step_value').find(".notic").hide();
      error_div.find("label").remove();
      error_div.append(error);
    },
    ignore:"",
    rules:{
      consignee :{
        required : true
      },
      country :{
        min : 1
      },
      province :{
        min : 1
      },
      city :{
        min : 1
      },
      district :{
        min : 1
      },
      address : {
        required : true
      },
      mobile : {
        required : true,
        isTel : true
      }
    },
    messages:{
      consignee:{
         required : '<i class="icon icon-exclamation-sign"></i>请填写收货人名称'
      },
      country :{
        min : '<i class="icon icon-exclamation-sign"></i>请选择国家'
      },
      province :{
        min : '<i class="icon icon-exclamation-sign"></i>请选择省/直辖市'
      },
      city :{
        min : '<i class="icon icon-exclamation-sign"></i>请选择城市'
      },
      district :{
        min : '<i class="icon icon-exclamation-sign"></i>请选择区/县'
      },
      address : {
        required : '<i class="icon icon-exclamation-sign"></i>请填写收货地址'
      },
      mobile : {
        required : '<i class="icon icon-exclamation-sign"></i>请填写手机号码',
        isTel : '<i class="icon icon-exclamation-sign"></i>手机号码不正确',
      }
    }     
  });
});
  
function checkUser()
  {
    var eles = document.forms['theForm'].elements;

    /* 如果搜索会员，检查是否找到 */
    if (document.getElementById('register_user').checked && eles['user'].value == "")
    {
        alert(pls_search_user);
        return false;
    }
    return true;
  }
  
/*function checkGoods()
{
    var eles = document.forms['theForm'].elements;

    if (eles['goods_count'].value <= 0)
    {
        alert(pls_search_goods);
        return false;
    }
    return true;
}*/
  
function checkConsignee()
{
    var eles = document.forms['theForm'].elements;

    if (eles['country'].value <= 0)
    {
        alert(pls_select_area);
        return false;
    }
    if (eles['province'].options.length > 1 && eles['province'].value <= 0)
    {
        alert(pls_select_area);
        return false;
    }
    if (eles['city'].options.length > 1 && eles['city'].value <= 0)
    {
        alert(pls_select_area);
        return false;
    }
    if (eles['district'].options.length > 1 && eles['district'].value <= 0)
    {
        alert(pls_select_area);
        return false;
    }
    if (eles['street'].options.length > 1 && eles['street'].value <= 0)
    {
        alert(pls_select_area);
        return false;
    }
    return true;
}
  
function checkShipping()
{
    if (!radioChecked('shipping'))
    {
        alert(pls_select_shipping);
        return false;
    }
    return true;
}
  
function checkPayment()
{
    if (!radioChecked('payment'))
    {
        alert(pls_select_payment);
        return false;
    }
    return true;
}
  
/**
 * 返回某 radio 是否被选中一个
 * @param string radioName
 */
function radioChecked(radioName)
{
    var eles = document.forms['theForm'].elements;

    for (var i = 0; i < eles.length; i++)
    {
        if (eles[i].name == radioName && eles[i].checked)
        {
            return true;
        }
    }
    return false;
}

$.divselect("#warehouse_id","#warehouse_id_val",function(){
    var warehouse_id = $("#warehouse_id_val").val();
    Ajax.call('goods_inventory_logs.php?is_ajax=1&act=search_area', "warehouse_id=" + warehouse_id, search_areaResult, "GET", "JSON");
});
  
function search_areaResult(result)
{
    $('#area_id').html(result.content);
}
  
$.divselect("#goodslist","#goodslist_val",function(){
    var goodsId = $("#goodslist_val").val();
    var warehouse_id = $("#warehouse_id_val").val();
    var area_id = $("#area_id_val").val();
    if (goodsId > 0)
    {
        Ajax.call('order.php?is_ajax=1&act=json&func=get_goods_info', 'goods_id=' + goodsId + '&warehouse_id=' + warehouse_id + '&area_id=' + area_id, getGoodsInfoResponse, 'get', 'json');
    }
    else
    {
        document.getElementById('goods_name').innerHTML = '';
        document.getElementById('goods_sn').innerHTML = '';
        document.getElementById('goods_cat').innerHTML = '';
        document.getElementById('goods_brand').innerHTML = '';
        document.getElementById('add_price').innerHTML = '';
        document.getElementById('goods_attr').innerHTML = '';
    }
});

function getGoodsInfoResponse(result)
{
    var eles = document.forms['goodsForm'].elements;

    // 显示商品名称、货号、分类、品牌
    document.getElementById('goods_name').innerHTML = result.goods_name;
    document.getElementById('goods_sn').innerHTML = result.goods_sn;
    document.getElementById('goods_cat').innerHTML = result.cat_name;
    document.getElementById('goods_brand').innerHTML = result.brand_name;
    document.getElementById('goods_storage').innerHTML = result.goods_storage;
    eles['model_attr'].value = result.model_attr;
    eles['attr_price'].value = result.attr_price;

    //显示价格：包括市场价、本店价（促销价）、会员价
    var priceHtml = '<div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="market_price" value="' + result.market_price + '" /><label for="market_price" class="ui-radio-label">市场价 [' + result.market_price + ']</label></div>' +
      '<div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="shop_price" value="' + result.goods_price + '" checked /><label for="shop_price" class="ui-radio-label">本店售价 [' + result.goods_price + ']</label></div>';
    for (var i = 0; i < result.user_price.length; i++)
    {
        priceHtml += '<div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="shop_price_'+i+'" value="' + result.user_price[i].user_price + '" /><label for="shop_price_'+i+'" class="ui-radio-label">' + result.user_price[i].rank_name + ' [' + result.user_price[i].user_price + ']</label></div>';
    }
    priceHtml += '<div class="checkbox_item"><input type="radio" name="add_price" class="ui-radio" id="custom_price" value="user_input" /><label for="custom_price" class="ui-radio-label mr10">' + input_price + '</label><input type="text" id="custom_price_value" name="input_price" class="text w120" value="" style="display:none;" /></div>';
    document.getElementById('add_price').innerHTML = priceHtml;

    //显示属性
    var specCnt = 0; // 规格的数量
    var attrHtml = '';
    var attrType = '';
    var attrTypeArray = '';
    var attrCnt = result.attr_list.length;
    for (i = 0; i < attrCnt; i++)
        {
            var valueCnt = result.attr_list[i].length;

            /*规格*/
            if (valueCnt > 1)
            {
                attrHtml += '<div class="checkbox_items"><div class="attr_name">' + result.attr_list[i][0].attr_name + '：</div>';
                for (var j = 0; j < valueCnt; j++)
                {
                    switch (result.attr_list[i][j].attr_type)
                    {
                        case '0' :
                        case '1' :
                        attrType = 'radio';
                        attrTypeArray = '';
                        break;

                        case '2' :
                        attrType = 'checkbox';
                        attrTypeArray = '[]';
                        break;
                    }
                    attrHtml += '<div class="checkbox_item"><input onclick="get_attr_number(' + result.goods_id + "," + result.warehouse_id + "," + result.area_id + "," + result.user_id + "," + result.model_attr + "," + result.goods_number + ')" type="' + attrType + '" name="spec_' + specCnt + attrTypeArray + '" value="' + result.attr_list[i][j].goods_attr_id + '" class="ui-radio" id="attr_'+result.attr_list[i][j].goods_attr_id+'"';
                    if (j == 0)
                    {
                        attrHtml += ' checked';
                    }
                    attrHtml += ' /><label class="ui-radio-label" for="attr_'+result.attr_list[i][j].goods_attr_id+'">' + result.attr_list[i][j].attr_value;
                    if (result.attr_list[i][j].attr_price > 0)
                    {
                        attrHtml += ' [+' + result.attr_list[i][j].attr_price + ']';
                    }
                    else if (result.attr_list[i][j].attr_price < 0)
                    {
                        attrHtml += ' [-' + Math.abs(result.attr_list[i][j].attr_price) + ']';
                    }
                    attrHtml += '</label></div>'
                }
                attrHtml += '</div>';
                specCnt++;
            }
            /*属性*/
            else
            {
                attrHtml += '<div class="checkbox_items"><div class="attr_name">'+result.attr_list[i][0].attr_name + '：</div>' + result.attr_list[i][0].attr_value + '</div>';
            }
        }
    eles['spec_count'].value = specCnt;
    document.getElementById('goods_attr').innerHTML = attrHtml;
}

function get_attr_number(goods_id, warehouse_id, area_id, user_id, model_attr, goods_number){
    var attr = getSelectedAttributes(document.forms['goodsForm']);
    Ajax.call('order.php?is_ajax=1&act=json&func=get_goods_attr_number', 'goods_id=' + goods_id + '&attr=' + attr + '&warehouse_id=' + warehouse_id + '&area_id=' + area_id + '&user_id=' + user_id + '&model_attr=' + model_attr + '&goods_number=' + goods_number, getGoodsAttrResponse, 'get', 'json');
}
  
function getGoodsAttrResponse(result){

    var eles = document.forms['goodsForm'].elements;

    document.getElementById('goods_storage').innerHTML = result.goods_storage;
    eles['attr_price'].value = result.attr_price;
}
  
/**
* 获得选定的商品属性
*/
function getSelectedAttributes(formBuy)
{
    var spec_arr = new Array();
    var j = 0;
    for (i = 0; i < formBuy.elements.length; i ++ )
    {
        var prefix = formBuy.elements[i].name.substr(0, 5);

        if (prefix == 'spec_' && (
            ((formBuy.elements[i].type == 'radio' || formBuy.elements[i].type == 'checkbox') && formBuy.elements[i].checked) ||
            formBuy.elements[i].tagName == 'SELECT'))
        {
            spec_arr[j] = formBuy.elements[i].value;
            j++ ;
        }
    }

    return spec_arr;
}
  
/**
 * 按用户编号或用户名搜索用户
 */
function searchUser()
{
    var eles = document.forms['theForm'].elements;

    /* 填充列表 */
    var idName = Utils.trim(eles['keyword'].value);

    if (idName != '')
    {
        Ajax.call('order.php?is_ajax=1&act=search_users&id_name=' + idName, '', searchUserResponse, 'GET', 'JSON');
    }
}

function searchUserResponse(result)
{

    if (result.message.length > 0)
    {
        alert(result.message);
    }

    if (result.error == 0)
    {
        $("#user").find('li').remove();

        var arr = result.userlist;

        for (var i = 0; i < arr.length; i++)
        {
            $("#user").children("ul").append("<li><a href='javascript:;' data-value='"+arr[i].user_id+"' class='ftx-01'>"+arr[i].user_name+"</a></li>")
        }
    }
}
  
/**
 * 按商品编号或商品名称或商品货号搜索商品
 */
function searchGoods()
{
    var eles = document.forms['goodsForm'].elements;
    var warehouse_id = eles['warehouse_id'].value;
    var area_id = eles['area_id'].value;
    // if(warehouse_id == 0){
        // alert('请选择仓库');
        // return false;
      // }else if(area_id == 0){
              // alert('请选择地区');
      // return false;
      // }else{
    /* 填充列表 */
    var keyword = Utils.trim(eles['keyword'].value);
    if (keyword != '')
    {
        Ajax.call('order.php?is_ajax=1&act=search_goods&keyword=' + keyword + '&order_id=1696' + '&warehouse_id=' + warehouse_id + '&area_id=' + area_id, '', searchGoodsResponse, 'GET', 'JSON');
    }
      // }
}

function searchGoodsResponse(result)
{
    if (result.message.length > 0)
    {
        alert(result.message);
    }

    if (result.error == 0)
    {
        $("#goodslist").find('li').remove();

        var arr = result.goodslist;

        for (var i = 0; i < arr.length; i++)
        {
            $("#goodslist").children("ul").append("<li><a href='javascript:;' data-value='"+arr[i].goods_id+"' class='ftx-01'>"+arr[i].name+"</a></li>")
        }
    }
}
  
function submit(){
    document.forms['theForm'].submit();
}
  
/**
 * 把商品加入订单
 */
function addToOrder()
{
    var form = $("form[name='goodsForm']");
    var warehouse_id = form.find("input[name='warehouse_id']").val();
    var area_id = form.find("input[name='area_id']").val();
    var add_number = form.find("input[name='add_number']").val();
    var goods_storage = $("#goods_storage").html();
    goods_storage = Number(goods_storage);

    // 检查是否选择了商品
    if (form.find("input[name='goodslist']") == "")
    {
        alert(pls_search_goods);
        return false; 
    }/*else if(warehouse_id == 0){
        alert('请选择仓库');
        return false;
    }else if(area_id == 0){
        alert('请选择地区');
        return false;
    }*/
  
  if(goods_storage == 0){
        alert('商品库存不足');
    return false;
  }
  
    if(add_number > goods_storage){
        alert('商品库存不足');
        return false;
    }

    return true;
}

function subOrderAdd(){
  var form = $("form[name='theFormNext']");
  
  if($(".goods_info").length > 0){
    return true;
  }else{
    alert("请先添加商品");
    return false;
  }
}
  
/**
 * 载入收货地址
 * @param int addressId 收货地址id
 */
function loadAddress(addressId)
{
    location.href += 'order.php?act=add&order_id=1696&step=goods&address_id=' + addressId;
}

$.divselect("#addresslist","#addresslist_val",function(obj){
    var value = obj.data("value");
    loadAddress(value);
});

$.divselect("#bonus_id","#bonus_id_val",function(obj){
    var money = obj.data("money");
    obj.parents(".imitate_select").find("input[name='bonus_val']").val(money);
});

/* 运算订单总金额不能为负数 */
function get_order_amount(){
  
  var goods_amount = $(":input[name='goods_amount']").val();
  var tax = $(":input[name='tax']").val();
  var shipping_fee = $(":input[name='shipping_fee']").val();
  var pay_fee = $(":input[name='pay_fee']").val();
  var discount = $(":input[name='discount']").val();

  var bonus = $(":input[name='bonus_val']").val();
  var money_paid = $(":input[name='money_paid']").val();
  var surplus = $(":input[name='surplus']").val();
  var integral = $(":input[name='integral']").val();
  var coupons = $(":input[name='coupons']").val();
  var value_card = $(":input[name='value_card']").val();
  
  var total_fee = Number(goods_amount) + Number(tax) + Number(shipping_fee) + Number(pay_fee) - Number(discount);
  
  if(total_fee < 0){
    alert("您修改的费用信息折扣不能大于实际订单总金额");
    return false;
  }
  
  if(total_fee == 0){
    var concessionary = Number(money_paid) + Number(surplus) - Number(coupons) - Number(integral) - Number(value_card) - Number(bonus);
    var order_amount = Number(total_fee) - Number(concessionary);
  }else{
    var order_amount = (Number(money_paid) + Number(surplus) + Number(coupons) + Number(integral) + Number(value_card) + Number(bonus) - total_fee) * -1;
  }
  
  var str = '';
    
  if(order_amount < 0){
    if(confirm("您修改的费用信息产生了负数（" + order_amount.toFixed(2) + "）" + str + "，会是否继续？")){
      $("form[name='theForm']").submit();
    }
  }else{
    $("form[name='theForm']").submit();
  }
}
</script>
</html>